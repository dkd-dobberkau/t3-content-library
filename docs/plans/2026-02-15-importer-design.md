# Phase 2: TYPO3 Content Importer - Design Document

## Goal

A TYPO3 v13 extension that imports Markdown files (generated by t3-content-library Phase 1) into TYPO3 as pages and content elements via the DataHandler API.

## Extension Details

- **Extension Key:** `content_importer`
- **Composer Name:** `dkd/content-importer`
- **TYPO3:** v13
- **Separate repo:** `/Users/olivier/Versioncontrol/local/ext-content-importer`

## CLI Interface

```bash
bin/typo3 content:import /path/to/markdown-files/ --pid=1
```

- First argument: directory containing .md files
- `--pid`: Root page UID under which pages are created
- Shows progress per page

## Architecture

### Extension Structure

```
ext-content-importer/
├── composer.json
├── ext_emconf.php
├── Configuration/
│   └── Services.yaml
├── Classes/
│   ├── Command/
│   │   └── ImportCommand.php
│   ├── Parser/
│   │   └── MarkdownPageParser.php
│   └── Service/
│       └── PageImportService.php
└── Tests/
    └── Unit/
        └── Parser/
            └── MarkdownPageParserTest.php
```

### Components

**ImportCommand** (Symfony Console Command)
- Takes path + pid as arguments
- Orchestrates Parser + Service
- Shows progress output
- Error handling

**MarkdownPageParser**
- Reads .md files from directory
- Parses YAML frontmatter (title, slug, parent, nav_position, seo)
- Extracts CE blocks by splitting on `<!-- CE: type -->` comments
- Returns structured array per page

**PageImportService**
- Receives parsed pages
- Builds page tree (parent-slug → pid resolution)
- Creates pages records via DataHandler
- Creates tt_content records via DataHandler
- Maps CE types to CType
- Sets sorting, colPos, bodytext, header etc.

### Data Flow

```
Markdown files in directory
     │
     ▼
MarkdownPageParser
  → Reads .md files
  → Parses YAML frontmatter
  → Extracts CE blocks via <!-- CE: --> comments
  → Returns structured array per page
     │
     ▼
PageImportService
  → Builds page tree (parent-slug → pid resolution)
  → Creates pages via DataHandler
  → Creates tt_content via DataHandler
     │
     ▼
ImportCommand
  → Orchestrates, shows progress, handles errors
```

### CE Type Mapping

| Markdown CE | TYPO3 CType | Fields |
|---|---|---|
| `header` | `header` | `header` from content |
| `text` | `text` | `bodytext` from content |
| `text, subtype: bullets` | `bullets` | `bodytext` as list |
| `text, subtype: table` | `table` | `bodytext` as pipe table |
| `textmedia` | `textmedia` | `bodytext` + image placeholder note |
| `image` | `image` | Image placeholder note |
| `quote` | `quote` | `bodytext` + `header` (author) |
| `accordion` | `text` | Fallback to text (no core accordion) |
| `shortcut` | `text` | Fallback to text |
| `uploads` | `text` | `bodytext` as text (no real files) |
| `menu` | `menu_pages` | `bodytext` as text |

**Note:** For `textmedia`/`image` with `placeholder://` URLs, no FAL references are created. The bodytext gets the content, image field stays empty.

### Page Tree Building

Two-pass approach:

**Pass 1:** Sort all pages by `nav_position`. Create top-level pages (`parent: "/"`) under `--pid`. Build slug → uid mapping.

**Pass 2:** Create child pages (e.g., `parent: "/ueber-uns"`) by looking up parent slug in the mapping.

Then for each page, create content elements in order with incrementing sorting values.

## Tech Decisions

- **DataHandler API** for all database writes (official TYPO3 way)
- **No FAL handling** for placeholder images (v1)
- **No accordion support** (no core CE, falls back to text)
- **Direct CType mapping** to TYPO3 core content elements
